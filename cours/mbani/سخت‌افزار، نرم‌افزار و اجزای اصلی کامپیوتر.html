<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>آزمون کامپیوتر چیست و انواع آن</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.fontcdn.ir/Font/Persian/Vazirmatn/Vazirmatn.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body {
      font-family: 'Vazirmatn', Tahoma, sans-serif;
      margin: 0; background: #f0f3ff; color: #24356b; direction: rtl;
    }
    .header {
      background: #fff; box-shadow: 0 2px 8px #4646bd12;
      padding: 18px 13px 10px 13px; text-align: right;
      display: flex; align-items: center; gap: 8px;
      position: sticky; top: 0; z-index: 10;
    }
    .header .back-btn { border:none; background: none; font-size: 1.1rem; color: #4267de; cursor: pointer;}
    .header h2 { font-size: 1.07rem; font-weight: 700; margin: 0 0 0 15px; letter-spacing: -.5px;}
    main {
      max-width: 520px; margin: 0 auto 68px auto; padding: 0 10px;
    }
    .question-box {
      background: #fff; border-radius: 17px; box-shadow: 0 4px 16px -6px #8e78ff18;
      padding: 24px 15px 16px 15px; margin-top:22px;
      display: flex; flex-direction: column; gap: 20px; position: relative;
      min-height:176px;
      transition: box-shadow .16s;
    }
    .question-number {
      color: #ad1deb; font-size:1.1em; font-weight: 900; margin-bottom: 3px;
      background: #f2e7fe; padding: 4px 16px; border-radius: 12px; display:inline-block;
    }
    .question-title {
      font-weight: bold; color: #32439a; font-size: 1.07rem; margin-bottom:8px;
    }
    .options-list { display: flex; flex-direction: column; gap: 13px;}
    .option-btn {
      border: 2px solid #e4e9fb; border-radius: 18px; padding: 7px 19px; cursor: pointer; background: #f0f6ff;
      color: #38498e; font-size: 1rem; text-align:right; transition: border .18s, background .16s;
      display: flex; align-items: center; gap: 8px;
    }
    .option-btn.selected { border: 2px solid #4e5fe0; background: #eff1fe;}
    .option-btn.correct { border:2px solid #1ab42d; background: #e5ffe9; color: #159822;}
    .option-btn.incorrect { border:2px solid #ff326e; background: #fff0f5; color: #b01f52;}
    .btn-row { display:flex; gap:12px; margin-top:18px;}
    .btn {
      border:none; outline:none; border-radius:10px; background: #4e5fe0;
      color: #fff; font-size:1em; font-weight: 600; padding: 9px 22px;
      box-shadow:0 2px 7px #4e5fe035; cursor:pointer; transition:background .15s;
    }
    .btn:disabled {
      background: #8f99e7; cursor: not-allowed;
    }
    .feedback {
      margin-top:7px; min-height:34px; font-size:1em; padding:7px 5px 2px 5px;
      color: #fff; border-radius: 8px; text-align: right;
      background: linear-gradient(92deg, #8e2de2e0 5%, #4e5fe0df 100%);
      box-shadow:0 2px 10px #8e78ff13; animation: fadeIn .5s;
    }
    .feedback.correct {background: #1abc9c;}
    .feedback.incorrect {background: #ea3575;}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .finished-modal {
      position:fixed; top:0; left:0; right:0; bottom:0; background:#1a1e2edd;
      z-index: 50; display: flex; align-items:center; justify-content:center; flex-direction:column;
      animation: fadeIn .4s;
    }
    .finished-modal .result-box {
      background:#fff; border-radius:21px; box-shadow:0 8px 40px #4e5fe088;
      padding:34px 31px 26px 31px; min-width:260px; text-align: center; max-width:97vw;
    }
    .score {font-size:2.1em; font-weight:900; color:#4e5fe0;}
    .result-label {font-size:1.19em; font-weight:700; color:#2e3579; margin:13px 0;}
    .modal-btn-row {display:flex; gap:15px;justify-content:center;}
    .modal-btn {
      padding: 9px 25px; font-size:1em; font-weight:600; border:none; border-radius:11px;
      background:#4e5fe0; color:#fff; cursor:pointer; margin-top:15px;
      transition: background .14s;
    }
    .modal-btn.secondary {background: #e1e4fa; color:#444;}
    .modal-btn:active {transform: scale(.96);}
    @media (max-width:630px){ main{padding:0 2vw;}.question-box{padding:12px 4vw 11px 4vw;} }
    .bottom-nav {
      position: fixed; left:0;right:0;bottom:0; background: #fff; z-index:100;
      box-shadow:0 -4px 16px -10px #7e21df14; display: flex; border-radius: 20px 20px 0 0;
      justify-content: space-around; padding: 4px 0 2px 0; font-size:15px;
    }
    .nav-item { color:#7c7fea; text-decoration:none; display: flex; flex-direction:column;
      align-items:center;flex:1;min-width:62px; padding:7px 0 3px 0; border-radius:16px;transition: background .13s;}
    .nav-item.active, .nav-item:hover { background:#f1f4ff; color:#4939be;}
    .nav-item i { font-size: 1.1em;}
  </style>
</head>
<body>
  <div class="header">
    <button class="back-btn" onclick="window.location.href='http://127.0.0.1:5500/front/courses.html'" title="بازگشت">
      <i class="fas fa-arrow-right"></i>
    </button>
    <h2>آزمون مبانی کامپیوتر</h2>
  </div>
  <main>
    <div id="quiz-wrap">
      <!-- سوال و گزینه‌ها اینجا می آیند -->
      <div style="text-align:center;color:#6e72fc;margin-top:34px;" id="loading">در حال بارگذاری...</div>
      <div id="quiz-content"></div>
    </div>
  </main>

   <div class="bottom-nav">
    <a href="/front/Dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>خانه</span></a>
    <a href="/front/Courses.html" class="nav-item"><i class="fas fa-book"></i><span>دوره‌ها</span></a>
    <a href="/quiz/basic/qmbni.html" class="nav-item"><i class="fas fa-graduation-cap"></i><span>درس‌ها</span></a>
    <a href="/front/Profile.html" class="nav-item"><i class="fas fa-user"></i><span>پروفایل</span></a>
  </div>

  <!-- Modal for result -->
  <div class="finished-modal" id="result-modal" style="display:none;">
    <div class="result-box">
      <span class="result-label" id="modal-label"></span>
      <div class="score" id="modal-score"></div>
      <div style="margin:20px 0 24px 0;" id="modal-summary"></div>
      <div class="modal-btn-row">
        <button class="modal-btn secondary" onclick="window.location.reload()">آزمون مجدد</button>
        <button class="modal-btn" id="confirm-btn">تایید</button>
      </div>
    </div>
  </div>
<script>
// ============ تنظیمات ویژه این آزمون ============
<!-- ====== تغییرات ویژه این آزمون ====== -->
const API_URL = "http://localhost:3001/questions?label=سخت‌افزار، نرم‌افزار و اجزای اصلی کامپیوتر";
const COURSE_KEY = "fundamental-cs";
const LESSON_LABEL = "سخت‌افزار، نرم‌افزار و اجزای اصلی کامپیوتر";


// ================================================

let questions = [];
let state = { idx: 0, selected: null, showAnswer: false, answers: [] };

const userId = localStorage.getItem('userId');
if(!userId) window.location.href = "LoginPage.html";

// واکشی سوالات و شروع آزمون
window.onload = async function() {
  try {
    const res = await fetch(API_URL);
    questions = await res.json();
    document.getElementById('loading').style.display="none";
    if(!Array.isArray(questions) || questions.length === 0){
      document.getElementById('quiz-content').innerHTML='<div style="color:#c23c3c;text-align:center;margin:45px 0;font-size:1.1em;">سوالی ثبت نشده است.</div>';
      return;
    }
    state = { idx:0, selected:null, showAnswer:false, answers:Array(questions.length).fill(null) };
    renderQuestion();
  }catch{
    document.getElementById('quiz-content').innerHTML='<div style="color:#c23c3c;text-align:center;">خطا در دریافت داده آزمون!</div>';
  }
}

// -- نمایش سوال جاری
function renderQuestion() {
  const q = questions[state.idx];
  let html = `
    <div class="question-number">سوال ${state.idx+1} از ${questions.length}</div>
    <div class="question-title">${q.question}</div>
    <div class="options-list">
    ${q.options.map((opt,i) => {
        let cls = '';
        if(state.showAnswer && state.selected===i) {
            cls = (i===q.answer) ? 'option-btn correct' : 'option-btn incorrect';
        } else if(state.answers[state.idx] && state.answers[state.idx].selected===i) {
            cls = state.answers[state.idx].correct ? 'option-btn correct' : 'option-btn incorrect';
        } else if(state.selected===i) {
            cls = 'option-btn selected';
        } else {
            cls = 'option-btn';
        }
        return `<button type="button" class="${cls}" onclick="selectOption(${i})">
          <span style="font-weight:700;">${String.fromCharCode(0x06F0+i+1)}</span>
          ${opt}
        </button>`;
    }).join('')}
    </div>
  `;
  html += `
  <div class="btn-row">
    <button class="btn" onclick="prevQuestion()" ${state.idx===0?"disabled":""}>سوال قبلی</button>
    <button class="btn" onclick="submitAnswer()">ثبت پاسخ</button>
    <button class="btn" onclick="nextQuestion()" ${state.idx===questions.length-1?"disabled":""}>سوال بعدی</button>
  </div>
  `;
  if(state.showAnswer) {
    const correct = state.selected === q.answer;
    html += `<div class="feedback ${correct?"correct":"incorrect"}">
      ${correct ? "آفرین! پاسخ صحیح بود." : "پاسخ اشتباه است."}
      <br>
      جواب درست: <b style='color:#1ab42d;'>${q.options[q.answer]}</b>
    </div>`;
  }
  document.getElementById('quiz-content').innerHTML = `<div class="question-box">${html}</div>`;
}

// -- انتخاب گزینه
function selectOption(i) {
  if(state.showAnswer) return;
  state.selected = i;
  renderQuestion();
}

// -- ثبت پاسخ و نمایش بازخورد
function submitAnswer() {
  if(state.showAnswer || state.selected===null) return;
  const correct = state.selected === questions[state.idx].answer;
  state.answers[state.idx] = { selected: state.selected, correct };
  state.showAnswer = true;
  renderQuestion();
  setTimeout(() => {
    state.showAnswer = false;
    if(state.idx<questions.length-1){
      state.idx++;
      state.selected = state.answers[state.idx]?.selected ?? null;
      renderQuestion();
    } else {
      showResult();
    }
  }, 1200);
}

function prevQuestion() {
  if(state.idx>0) {
    state.idx--;
    state.selected = state.answers[state.idx]?.selected ?? null;
    state.showAnswer = false;
    renderQuestion();
  }
}
function nextQuestion() {
  if(state.idx<questions.length-1) {
    state.idx++;
    state.selected = state.answers[state.idx]?.selected ?? null;
    state.showAnswer = false;
    renderQuestion();
  }
}

// -- نمایش نتیجه نهایی
function showResult() {
  const numCorrect = state.answers.filter(a=>a&&a.correct).length;
  const score = Math.round(numCorrect / questions.length * 100);
  document.getElementById('result-modal').style.display="flex";
  document.getElementById('modal-label').textContent = "پایان آزمون";
  document.getElementById('modal-score').textContent = `${score} از ۱۰۰`;
  document.getElementById('modal-summary').innerHTML = `
    تعداد پاسخ صحیح: <b>${numCorrect}</b>
    <br> تعداد پاسخ نادرست: <b>${questions.length-numCorrect}</b>
  `;
  document.getElementById('confirm-btn').onclick = function(){
    saveQuizResult(score).then(()=>{
      window.location.href='http://127.0.0.1:5500/front/Profile.html';
    });
  };
}

// -- ذخیره نتیجه آزمون و بروزرسانی progress
async function saveQuizResult(score){
  try {
    // گرفتن اطلاعات کاربر
    const res = await fetch(`http://localhost:3001/users/${userId}`);
    const user = await res.json();
    let progressArr = user.progress || [];

    // پیدا یا ساختن رکورد پیشرفت این دوره
    let courseProgress = progressArr.find(item=>item.courseKey===COURSE_KEY);
    if(!courseProgress){
      courseProgress = { courseKey: COURSE_KEY, lessonsPassed: [] };
      progressArr.push(courseProgress);
    }

    // رفع باگ اصلی: تضمین آرایه بودن lessonsPassed
    if(!Array.isArray(courseProgress.lessonsPassed)){
      courseProgress.lessonsPassed = [];
    }

    // اضافه کردن درس به دروس گذرانده
    if(!courseProgress.lessonsPassed.includes(LESSON_LABEL)){
      courseProgress.lessonsPassed.push(LESSON_LABEL);
    }

    // ذخیره رکورد آزمون
    user.quizRecords = user.quizRecords || {};
    user.quizRecords[LESSON_LABEL] = { score, date: Date.now() };

    // ارسال به سرور
    await fetch(`http://localhost:3001/users/${userId}`, {
      method: 'PATCH',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        progress: progressArr,
        quizRecords: user.quizRecords
      })
    });
  } catch(e) {
    alert("خطا در ذخیره نتیجه آزمون! " + (e.message||''));
  }
}
</script>

  
</body>
</html>
